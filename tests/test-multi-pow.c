/*
 * Copyright (C) 2019 BiiLabs Co., Ltd. and Contributors
 * All Rights Reserved.
 * This is free software; you can redistribute it and/or modify it under the
 * terms of the MIT license. A copy of the license can be found in the file
 * "LICENSE" at the root of this distribution.
 */

/* Test program for thread-safe dcurl */
#include <pthread.h>
#include "common.h"
#include "dcurl.h"

#define THREAD_MAX 10

typedef struct _dcurl_item dcurl_item;
struct _dcurl_item {
    int mwm;
    int8_t input_trytes[TRANSACTION_TRYTES_LENGTH];  /* 2673 */
    int8_t output_trytes[TRANSACTION_TRYTES_LENGTH]; /* 2673 */
};

void *dcurl_entry_cb(void *arg)
{
    dcurl_item *item = (dcurl_item *) arg;
    /* test dcurl Implementation with mwm = 14 */
    int8_t *ret_trytes = dcurl_entry(item->input_trytes, item->mwm, 8);
    assert(ret_trytes && "dcurl_entry() failed");
    memcpy(item->output_trytes, ret_trytes, TRANSACTION_TRYTES_LENGTH);
    free(ret_trytes);

    pthread_exit(NULL);
}

int main()
{
    char *transaction_trytes =
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "99999999999999999A9RGRKVGWMWMKOLVMDFWJUHNUNYWZTJADGGPZGXNLERLXYWJE9WQH"
        "WWBMCPZMVVMJUMWWBLZLNMLDCGDJ999999999999999999999999999999999999999999"
        "999999999999YGYQIVD99999999999999999999TXEFLKNPJRBYZPORHZU9CEMFIFVVQBU"
        "STDGSJCZMBTZCDTTJVUFPTCCVHHORPMGCURKTH9VGJIXUQJVHK99999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999999999999999999999999999999999999999999999999999999999999"
        "9999999999999";

    int mwm = 14;
    pthread_t threads[THREAD_MAX];
    dcurl_item items[THREAD_MAX];

    dcurl_init(NULL);

    for (int i = 0; i < THREAD_MAX; i++) {
        memcpy(items[i].input_trytes, transaction_trytes, TRANSACTION_TRYTES_LENGTH);
        items[i].mwm = mwm;
        pthread_create(&threads[i], NULL, dcurl_entry_cb, (void *) &items[i]);
    }

    for (int i = 0; i < THREAD_MAX; i++)
        pthread_join(threads[i], NULL);

    for (int i = 0; i < THREAD_MAX; i++) {
        trytes_t *trytes =
            init_trytes(items[i].output_trytes, TRANSACTION_TRYTES_LENGTH);
        assert(trytes && "init_trytes() failed");
        trytes_t *hashed_trytes = hash_trytes(trytes);
        assert(hashed_trytes && "hash_trytes() failed");

        /* Validation */
        trits_t *ret_trits = trits_from_trytes(hashed_trytes);
        for (int j = 243 - 1; j >= 243 - items[i].mwm; j--) {
            assert(ret_trits->data[j] == 0 && "Validation failed");
        }

        free_trinary_object(trytes);
        free_trinary_object(hashed_trytes);
        free_trinary_object(ret_trits);
    }

    dcurl_destroy();

    return 0;
}
